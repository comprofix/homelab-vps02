name: Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Run entire job **inside a container that already has Ansible**
    container:
      image: quay.io/ansible/creator-ee:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write known hosts
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          # Write private key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Optionally write public key if needed
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 644 ~/.ssh/id_rsa.pub

          # Start ssh-agent and add private key
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

          # Optional config (disable strict host checking if desired)
          echo "Host *" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Install Galaxy Roles
        run: ansible-galaxy install -r requirements.yml

      - name: Run Playbook
        run: |        
          ansible-playbook main.yml \
            --extra-vars "traefik_host=${{ secrets.traefik_host }} \
            traefik_api_password=${{ secrets.traefik_api_password }} \
            CF_API_EMAIL=${{ secrets.CF_API_EMAIL }} \
            CF_DNS_API_TOKEN=${{ secrets.CF_DNS_API_TOKEN }} \
            traefik_api_user=${{ secrets.traefik_api_user }}"


          